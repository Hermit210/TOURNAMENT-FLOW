<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TournamentFlow — Tournament Rewards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./js/tournament-data.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <header class="border-b border-slate-800/60 bg-slate-900/60 backdrop-blur sticky top-0 z-50">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="./logo.svg" class="h-8 w-8" alt="TournamentFlow logo"/>
          <a href="./index.html" class="font-semibold text-indigo-300">TournamentFlow</a>
        </div>
        <nav class="hidden sm:flex items-center gap-6 text-sm">
          <a class="text-slate-300 hover:text-white transition-colors" href="./tournaments.html">Tournaments</a>
          <a class="text-slate-300 hover:text-white transition-colors" href="./rewards.html">Rewards</a>
          <a class="text-slate-300 hover:text-white transition-colors" href="./docs.html">Docs</a>
        </nav>
        <button id="mobile-menu" class="sm:hidden p-2 text-slate-300 hover:text-white">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
      <div id="mobile-nav" class="hidden sm:hidden border-t border-slate-800/60 bg-slate-900/80 backdrop-blur">
        <nav class="max-w-6xl mx-auto px-4 py-3 flex flex-col gap-3 text-sm">
          <a class="text-slate-300 hover:text-white transition-colors" href="./tournaments.html">Tournaments</a>
          <a class="text-slate-300 hover:text-white transition-colors" href="./rewards.html">Rewards</a>
          <a class="text-slate-300 hover:text-white transition-colors" href="./docs.html">Docs</a>
        </nav>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 md:py-10">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-8">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold mb-2">Tournament Rewards & Payouts</h1>
          <p class="text-slate-400">Real-time prize distribution powered by Kwala automation</p>
        </div>
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 mt-4 sm:mt-0">
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span class="text-sm text-slate-400">Live tracking</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
              <span class="text-sm text-slate-400" id="last-update">Updated now</span>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="refresh" class="px-3 py-1.5 text-sm bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              Refresh
            </button>
            <button id="export-data" class="px-3 py-1.5 text-sm bg-indigo-600 hover:bg-indigo-500 rounded-lg transition-colors">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Export
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="p-4 bg-slate-900/60 border border-slate-800 rounded-lg text-center">
          <div class="text-2xl font-bold text-indigo-300" id="completed-tournaments">0</div>
          <div class="text-xs text-slate-400">Tournaments Completed</div>
        </div>
        <div class="p-4 bg-slate-900/60 border border-slate-800 rounded-lg text-center">
          <div class="text-2xl font-bold text-green-400" id="eth-distributed">0.0</div>
          <div class="text-xs text-slate-400">ETH Distributed</div>
        </div>
        <div class="p-4 bg-slate-900/60 border border-slate-800 rounded-lg text-center">
          <div class="text-2xl font-bold text-blue-400" id="active-tournaments">0</div>
          <div class="text-xs text-slate-400">Active Tournaments</div>
        </div>
        <div class="p-4 bg-slate-900/60 border border-slate-800 rounded-lg text-center">
          <div class="text-2xl font-bold text-purple-400" id="avg-payout-time">1.2s</div>
          <div class="text-xs text-slate-400">Avg Payout Time</div>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="mb-6 flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div class="flex flex-wrap gap-2">
          <button class="filter-btn active px-3 py-1 text-sm rounded-lg bg-indigo-600 text-white" data-filter="all">All Payouts</button>
          <button class="filter-btn px-3 py-1 text-sm rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700" data-filter="1st Place">Winners</button>
          <button class="filter-btn px-3 py-1 text-sm rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700" data-filter="today">Today</button>
          <button class="filter-btn px-3 py-1 text-sm rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700" data-filter="high-value">High Value</button>
        </div>
        <div class="flex items-center gap-2">
          <div class="relative">
            <input type="text" id="search-payouts" placeholder="Search tournaments or players..." 
                   class="pl-8 pr-3 py-1.5 text-sm bg-slate-800 border border-slate-700 rounded-lg text-slate-300 focus:border-indigo-500 focus:outline-none">
            <svg class="w-4 h-4 absolute left-2.5 top-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <select id="sort-payouts" class="px-3 py-1.5 text-sm bg-slate-800 border border-slate-700 rounded-lg text-slate-300">
            <option value="time">Latest First</option>
            <option value="amount">Highest Amount</option>
            <option value="tournament">Tournament Name</option>
          </select>
        </div>
      </div>

      <!-- Recent Payouts Grid -->
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6" id="payouts-grid">
        <!-- Payouts will be loaded dynamically from tournament data -->
        <div class="col-span-full text-center py-8">
          <div class="text-slate-400 mb-4">
            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p>No tournament payouts yet</p>
            <p class="text-sm">Complete tournaments will appear here with automatic prize distribution</p>
          </div>
          <a href="./tournaments.html" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Create Tournament
          </a>
        </div>
      </div>

      <!-- Load More Button -->
      <div class="text-center mt-8">
        <button id="load-more" class="hidden px-6 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg font-semibold transition-colors">
          Load More Payouts
        </button>
      </div>
      
      <!-- Prize Analytics -->
      <section class="mb-8">
        <h2 class="text-xl font-bold mb-4">Prize Analytics</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Prize Distribution Chart -->
          <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6">
            <h3 class="font-semibold text-indigo-300 mb-4">💰 Prize Distribution</h3>
            <div id="prize-chart" class="space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-sm text-slate-400">0-1 ETH</span>
                <div class="flex-1 mx-3 bg-slate-800 rounded-full h-2">
                  <div class="bg-green-500 h-2 rounded-full" style="width: 60%" id="range-0-1"></div>
                </div>
                <span class="text-sm text-slate-300" id="count-0-1">0</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-slate-400">1-5 ETH</span>
                <div class="flex-1 mx-3 bg-slate-800 rounded-full h-2">
                  <div class="bg-blue-500 h-2 rounded-full" style="width: 30%" id="range-1-5"></div>
                </div>
                <span class="text-sm text-slate-300" id="count-1-5">0</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-slate-400">5+ ETH</span>
                <div class="flex-1 mx-3 bg-slate-800 rounded-full h-2">
                  <div class="bg-purple-500 h-2 rounded-full" style="width: 10%" id="range-5-plus"></div>
                </div>
                <span class="text-sm text-slate-300" id="count-5-plus">0</span>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6">
            <h3 class="font-semibold text-indigo-300 mb-4">📊 Recent Activity</h3>
            <div id="activity-feed" class="space-y-3 max-h-48 overflow-y-auto">
              <div class="text-center py-8 text-slate-400">
                <p>No recent activity</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Leaderboard Section -->
      <section class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Top Players</h2>
          <div class="flex gap-2">
            <button class="leaderboard-tab active px-3 py-1 text-sm rounded-lg bg-indigo-600 text-white" data-tab="winners">Winners</button>
            <button class="leaderboard-tab px-3 py-1 text-sm rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700" data-tab="active">Most Active</button>
            <button class="leaderboard-tab px-3 py-1 text-sm rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700" data-tab="recent">Recent</button>
          </div>
        </div>
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6">
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Top Winners -->
            <div id="winners-tab" class="leaderboard-content">
              <h3 class="font-semibold text-indigo-300 mb-4">🏆 Top Winners</h3>
              <div id="top-winners" class="space-y-3">
                <div class="text-center py-8 text-slate-400">
                  <p>No tournament winners yet</p>
                  <p class="text-sm">Complete tournaments to see leaderboard</p>
                </div>
              </div>
            </div>

            <!-- Most Active -->
            <div id="active-tab" class="leaderboard-content hidden">
              <h3 class="font-semibold text-indigo-300 mb-4">⚡ Most Active</h3>
              <div id="most-active" class="space-y-3">
                <div class="text-center py-8 text-slate-400">
                  <p>No active players yet</p>
                  <p class="text-sm">Join tournaments to appear here</p>
                </div>
              </div>
            </div>

            <!-- Recent Winners -->
            <div id="recent-tab" class="leaderboard-content hidden">
              <h3 class="font-semibold text-indigo-300 mb-4">🎯 Recent Winners</h3>
              <div id="recent-winners" class="space-y-3">
                <div class="text-center py-8 text-slate-400">
                  <p>No recent winners</p>
                  <p class="text-sm">Recent tournament winners will appear here</p>
                </div>
              </div>
            </div>

            <!-- Player Stats -->
            <div class="md:col-span-1">
              <h3 class="font-semibold text-indigo-300 mb-4">📈 Platform Stats</h3>
              <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                  <span class="text-slate-400">Total Prize Pool</span>
                  <span class="text-green-400 font-semibold" id="total-prize-distributed">0 ETH</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                  <span class="text-slate-400">Average Prize</span>
                  <span class="text-blue-400 font-semibold" id="average-prize">0 ETH</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                  <span class="text-slate-400">Biggest Win</span>
                  <span class="text-purple-400 font-semibold" id="biggest-win">0 ETH</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                  <span class="text-slate-400">Win Rate</span>
                  <span class="text-yellow-400 font-semibold" id="platform-win-rate">0%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="mt-8 p-4 bg-slate-900/40 border border-slate-800 rounded-lg">
        <h3 class="font-semibold text-indigo-300 mb-2">Kwala-Powered Automation</h3>
        <p class="text-slate-400 text-sm">All tournament payouts are automated through Kwala workflows. Prize distribution happens instantly when tournaments complete, with transparent on-chain verification. Connect to webhooks or indexers for real-time tournament monitoring.</p>
      </div>
    </main>

    <script>
      // Initialize page with tournament data
      document.addEventListener('DOMContentLoaded', () => {
        loadTournamentData();
        setupEventListeners();
        
        // Listen for tournament events
        window.tournamentData.addEventListener('tournament_completed', (data) => {
          loadPayouts();
          updateStats();
          updateLeaderboard();
          showNotification(`Tournament "${data.tournament.name}" completed! Winner: ${data.payout.winner.username}`, 'success');
        });

        window.tournamentData.addEventListener('player_registered', (data) => {
          updateStats();
        });
      });

      function loadTournamentData() {
        updateStats();
        loadPayouts();
        updateLeaderboard();
        updatePrizeAnalytics();
        updateLastUpdateTime();
      }

      function updateStats() {
        const stats = window.tournamentData.getStatistics();
        
        document.getElementById('completed-tournaments').textContent = stats.completedTournaments;
        document.getElementById('eth-distributed').textContent = stats.totalPrizeDistributed.toFixed(1);
        document.getElementById('active-tournaments').textContent = stats.activeTournaments;
        document.getElementById('avg-payout-time').textContent = stats.averagePayoutTime + 's';
      }

      function loadPayouts() {
        const payouts = window.tournamentData.getAllPayouts();
        const payoutsGrid = document.getElementById('payouts-grid');
        
        if (payouts.length === 0) {
          payoutsGrid.innerHTML = `
            <div class="col-span-full text-center py-8">
              <div class="text-slate-400 mb-4">
                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p>No tournament payouts yet</p>
                <p class="text-sm">Complete tournaments will appear here with automatic prize distribution</p>
              </div>
              <a href="./tournaments.html" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Create Tournament
              </a>
            </div>
          `;
          return;
        }

        payoutsGrid.innerHTML = payouts.map(payout => createPayoutCard(payout)).join('');
        
        // Add click handlers to payout cards
        payoutsGrid.querySelectorAll('.payout-card').forEach(card => {
          card.addEventListener('click', () => {
            const payoutId = card.dataset.payoutId;
            const payout = payouts.find(p => p.id === payoutId);
            if (payout) {
              showPayoutDetails(payout);
            }
          });
        });
      }

      function createPayoutCard(payout) {
        const positionColors = {
          '1st Place': 'yellow-400',
          '2nd Place': 'gray-400', 
          '3rd Place': 'orange-400'
        };
        const color = positionColors[payout.position] || 'blue-400';
        
        return `
          <div class="payout-card p-4 bg-slate-900 border border-slate-800 rounded-lg hover:border-slate-700 transition-colors cursor-pointer" data-payout-id="${payout.id}">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-slate-400">${payout.tournamentName}</div>
              <div class="text-xs text-${color} bg-${color}/10 px-2 py-1 rounded">${payout.position}</div>
            </div>
            <div class="font-semibold text-green-400 mb-1">${payout.prizeAmount.toFixed(2)} ETH Prize</div>
            <div class="text-sm text-slate-300 mb-2">Winner: ${payout.winner.username}</div>
            <div class="text-xs text-slate-400">to ${window.tournamentData.formatAddress(payout.winner.address)}</div>
            <div class="text-xs text-slate-500 mt-2">${window.tournamentData.formatTimeAgo(payout.timestamp)}</div>
          </div>
        `;
      }

      function updateLeaderboard() {
        const leaderboard = window.tournamentData.getLeaderboard();
        
        // Update top winners
        const topWinnersEl = document.getElementById('top-winners');
        if (leaderboard.topWinners.length === 0) {
          topWinnersEl.innerHTML = `
            <div class="text-center py-8 text-slate-400">
              <p>No tournament winners yet</p>
              <p class="text-sm">Complete tournaments to see leaderboard</p>
            </div>
          `;
        } else {
          topWinnersEl.innerHTML = leaderboard.topWinners.slice(0, 3).map((player, index) => {
            const colors = ['yellow-500', 'gray-400', 'orange-500'];
            const bgColors = ['yellow', 'gray', 'orange'];
            return `
              <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-${colors[index]} rounded-full flex items-center justify-center text-sm font-bold text-black">${index + 1}</div>
                  <div>
                    <div class="font-semibold text-slate-200">${player.username}</div>
                    <div class="text-xs text-slate-400">${player.tournamentsWon || 0} tournaments won</div>
                  </div>
                </div>
                <div class="text-green-400 font-semibold">${(player.totalEarnings || 0).toFixed(1)} ETH</div>
              </div>
            `;
          }).join('');
        }

        // Update most active
        const mostActiveEl = document.getElementById('most-active');
        if (leaderboard.mostActive.length === 0) {
          mostActiveEl.innerHTML = `
            <div class="text-center py-8 text-slate-400">
              <p>No active players yet</p>
              <p class="text-sm">Join tournaments to appear here</p>
            </div>
          `;
        } else {
          mostActiveEl.innerHTML = leaderboard.mostActive.slice(0, 3).map((player, index) => {
            const colors = ['blue-500', 'blue-400', 'blue-300'];
            const winRate = player.tournamentsWon && player.tournamentsPlayed ? 
              Math.round((player.tournamentsWon / player.tournamentsPlayed) * 100) : 0;
            return `
              <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-${colors[index]} rounded-full flex items-center justify-center text-sm font-bold">${index + 1}</div>
                  <div>
                    <div class="font-semibold text-slate-200">${player.username}</div>
                    <div class="text-xs text-slate-400">${player.tournamentsPlayed || 0} tournaments played</div>
                  </div>
                </div>
                <div class="text-blue-400 font-semibold">${winRate}% Win Rate</div>
              </div>
            `;
          }).join('');
        }
      }

      function setupEventListeners() {
        // Enhanced refresh functionality
        document.getElementById('refresh').addEventListener('click', () => {
          const btn = document.getElementById('refresh');
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Refreshing...';
          btn.disabled = true;
          
          setTimeout(() => {
            loadTournamentData();
            updateLastUpdateTime();
            btn.innerHTML = originalHTML;
            btn.disabled = false;
            showNotification('Rewards updated!', 'success');
          }, 1000);
        });

        // Export data functionality
        document.getElementById('export-data').addEventListener('click', () => {
          exportPayoutData();
        });

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            // Update active filter
            document.querySelectorAll('.filter-btn').forEach(b => {
              b.classList.remove('active', 'bg-indigo-600', 'text-white');
              b.classList.add('bg-slate-800', 'text-slate-300');
            });
            btn.classList.add('active', 'bg-indigo-600', 'text-white');
            btn.classList.remove('bg-slate-800', 'text-slate-300');
            
            filterPayouts();
          });
        });

        // Search functionality
        document.getElementById('search-payouts').addEventListener('input', filterPayouts);
        document.getElementById('sort-payouts').addEventListener('change', filterPayouts);

        // Leaderboard tabs
        document.querySelectorAll('.leaderboard-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            switchLeaderboardTab(tabName);
          });
        });

        // Load more functionality
        document.getElementById('load-more').addEventListener('click', () => {
          loadMorePayouts();
        });
      }

      function updateLastUpdateTime() {
        document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();
      }

      function exportPayoutData() {
        const payouts = window.tournamentData.getAllPayouts();
        const csvContent = "data:text/csv;charset=utf-8," + 
          "Tournament,Winner,Prize Amount,Position,Date,Transaction Hash\n" +
          payouts.map(p => 
            `"${p.tournamentName}","${p.winner.username}",${p.prizeAmount},"${p.position}","${new Date(p.timestamp).toISOString()}","${p.transactionHash}"`
          ).join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `tournament-payouts-${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Payout data exported successfully!', 'success');
      }

      let currentFilter = 'all';
      let displayedPayouts = 6;

      function filterPayouts() {
        const filter = document.querySelector('.filter-btn.active').dataset.filter;
        const search = document.getElementById('search-payouts').value.toLowerCase();
        const sort = document.getElementById('sort-payouts').value;
        
        let payouts = window.tournamentData.getAllPayouts();
        
        // Apply filters
        if (filter !== 'all') {
          if (filter === '1st Place') {
            payouts = payouts.filter(p => p.position === '1st Place');
          } else if (filter === 'today') {
            const today = new Date().toDateString();
            payouts = payouts.filter(p => new Date(p.timestamp).toDateString() === today);
          } else if (filter === 'high-value') {
            payouts = payouts.filter(p => p.prizeAmount >= 2.0);
          }
        }
        
        // Apply search
        if (search) {
          payouts = payouts.filter(p => 
            p.tournamentName.toLowerCase().includes(search) ||
            p.winner.username.toLowerCase().includes(search)
          );
        }
        
        // Apply sorting
        payouts.sort((a, b) => {
          switch(sort) {
            case 'amount':
              return b.prizeAmount - a.prizeAmount;
            case 'tournament':
              return a.tournamentName.localeCompare(b.tournamentName);
            case 'time':
            default:
              return b.timestamp - a.timestamp;
          }
        });
        
        displayPayouts(payouts);
      }

      function displayPayouts(payouts) {
        const payoutsGrid = document.getElementById('payouts-grid');
        const loadMoreBtn = document.getElementById('load-more');
        
        if (payouts.length === 0) {
          payoutsGrid.innerHTML = `
            <div class="col-span-full text-center py-8">
              <div class="text-slate-400 mb-4">
                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <p>No payouts found</p>
                <p class="text-sm">Try adjusting your filters or search terms</p>
              </div>
            </div>
          `;
          loadMoreBtn.classList.add('hidden');
          return;
        }

        const visiblePayouts = payouts.slice(0, displayedPayouts);
        payoutsGrid.innerHTML = visiblePayouts.map(payout => createPayoutCard(payout)).join('');
        
        // Show/hide load more button
        if (payouts.length > displayedPayouts) {
          loadMoreBtn.classList.remove('hidden');
        } else {
          loadMoreBtn.classList.add('hidden');
        }
        
        // Add click handlers
        payoutsGrid.querySelectorAll('.payout-card').forEach(card => {
          card.addEventListener('click', () => {
            const payoutId = card.dataset.payoutId;
            const payout = payouts.find(p => p.id === payoutId);
            if (payout) {
              showPayoutDetails(payout);
            }
          });
        });
      }

      function loadMorePayouts() {
        displayedPayouts += 6;
        filterPayouts();
      }

      function switchLeaderboardTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.leaderboard-tab').forEach(tab => {
          tab.classList.remove('active', 'bg-indigo-600', 'text-white');
          tab.classList.add('bg-slate-800', 'text-slate-300');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'bg-indigo-600', 'text-white');
        document.querySelector(`[data-tab="${tabName}"]`).classList.remove('bg-slate-800', 'text-slate-300');
        
        // Show/hide content
        document.querySelectorAll('.leaderboard-content').forEach(content => {
          content.classList.add('hidden');
        });
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        
        // Load specific data
        if (tabName === 'recent') {
          loadRecentWinners();
        }
      }

      function loadRecentWinners() {
        const recentPayouts = window.tournamentData.getAllPayouts().slice(0, 5);
        const recentWinnersEl = document.getElementById('recent-winners');
        
        if (recentPayouts.length === 0) {
          recentWinnersEl.innerHTML = `
            <div class="text-center py-8 text-slate-400">
              <p>No recent winners</p>
              <p class="text-sm">Recent tournament winners will appear here</p>
            </div>
          `;
          return;
        }

        recentWinnersEl.innerHTML = recentPayouts.map((payout, index) => `
          <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-sm font-bold">${index + 1}</div>
              <div>
                <div class="font-semibold text-slate-200">${payout.winner.username}</div>
                <div class="text-xs text-slate-400">${payout.tournamentName} • ${window.tournamentData.formatTimeAgo(payout.timestamp)}</div>
              </div>
            </div>
            <div class="text-green-400 font-semibold">${payout.prizeAmount.toFixed(2)} ETH</div>
          </div>
        `).join('');
      }

      function updatePrizeAnalytics() {
        const payouts = window.tournamentData.getAllPayouts();
        
        if (payouts.length === 0) return;

        // Prize distribution
        const ranges = {
          '0-1': payouts.filter(p => p.prizeAmount < 1).length,
          '1-5': payouts.filter(p => p.prizeAmount >= 1 && p.prizeAmount < 5).length,
          '5-plus': payouts.filter(p => p.prizeAmount >= 5).length
        };

        const total = payouts.length;
        document.getElementById('count-0-1').textContent = ranges['0-1'];
        document.getElementById('count-1-5').textContent = ranges['1-5'];
        document.getElementById('count-5-plus').textContent = ranges['5-plus'];

        // Update bar widths
        document.getElementById('range-0-1').style.width = `${(ranges['0-1'] / total) * 100}%`;
        document.getElementById('range-1-5').style.width = `${(ranges['1-5'] / total) * 100}%`;
        document.getElementById('range-5-plus').style.width = `${(ranges['5-plus'] / total) * 100}%`;

        // Platform stats
        const totalPrize = payouts.reduce((sum, p) => sum + p.prizeAmount, 0);
        const averagePrize = totalPrize / payouts.length;
        const biggestWin = Math.max(...payouts.map(p => p.prizeAmount));

        document.getElementById('total-prize-distributed').textContent = totalPrize.toFixed(2) + ' ETH';
        document.getElementById('average-prize').textContent = averagePrize.toFixed(2) + ' ETH';
        document.getElementById('biggest-win').textContent = biggestWin.toFixed(2) + ' ETH';
        document.getElementById('platform-win-rate').textContent = '100%'; // All tournaments have winners

        // Update activity feed
        updateActivityFeed();
      }

      function updateActivityFeed() {
        const payouts = window.tournamentData.getAllPayouts().slice(0, 5);
        const activityFeed = document.getElementById('activity-feed');
        
        if (payouts.length === 0) {
          activityFeed.innerHTML = `
            <div class="text-center py-8 text-slate-400">
              <p>No recent activity</p>
            </div>
          `;
          return;
        }

        activityFeed.innerHTML = payouts.map(payout => `
          <div class="flex items-center gap-3 p-2 hover:bg-slate-800/30 rounded-lg transition-colors">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <div class="flex-1 min-w-0">
              <div class="text-sm text-slate-300 truncate">${payout.winner.username} won ${payout.prizeAmount.toFixed(2)} ETH</div>
              <div class="text-xs text-slate-500">${window.tournamentData.formatTimeAgo(payout.timestamp)}</div>
            </div>
          </div>
        `).join('');
      }

      // Add new payout function
      function addNewPayout() {
        const payoutsGrid = document.getElementById('payouts-grid');
        const tournaments = [
          'Crypto Masters', 'NFT Arena', 'DeFi Duel', 'Web3 Warriors', 
          'Blockchain Battle', 'Token Tournament', 'Digital Duel'
        ];
        const players = [
          'CryptoLegend', 'BlockMaster', 'ChainHero', 'TokenKing', 
          'NFTChampion', 'DeFiPro', 'Web3Ace', 'MetaGamer'
        ];
        const positions = ['1st Place', '2nd Place', '3rd Place'];
        const colors = ['yellow-400', 'gray-400', 'orange-400'];
        
        const tournament = tournaments[Math.floor(Math.random() * tournaments.length)];
        const player = players[Math.floor(Math.random() * players.length)];
        const positionIndex = Math.floor(Math.random() * positions.length);
        const position = positions[positionIndex];
        const color = colors[positionIndex];
        const prize = (Math.random() * 5 + 0.5).toFixed(1);
        const address = '0x' + Math.random().toString(16).substr(2, 6) + '...' + Math.random().toString(16).substr(2, 4);
        
        const newPayout = document.createElement('div');
        newPayout.className = 'p-4 bg-slate-900 border border-slate-800 rounded-lg hover:border-slate-700 transition-colors animate-pulse';
        newPayout.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm text-slate-400">${tournament} #${Math.floor(Math.random() * 100) + 50}</div>
            <div class="text-xs text-${color} bg-${color}/10 px-2 py-1 rounded">${position}</div>
          </div>
          <div class="font-semibold text-green-400 mb-1">${prize} ETH Prize</div>
          <div class="text-sm text-slate-300 mb-2">Winner: ${player}</div>
          <div class="text-xs text-slate-400">to ${address}</div>
          <div class="text-xs text-slate-500 mt-2">Just now</div>
        `;
        
        // Add to beginning of grid
        payoutsGrid.insertBefore(newPayout, payoutsGrid.firstChild);
        
        // Remove animation after 3 seconds
        setTimeout(() => {
          newPayout.classList.remove('animate-pulse');
        }, 3000);
        
        // Keep only latest 12 payouts
        const payouts = payoutsGrid.children;
        if (payouts.length > 12) {
          payoutsGrid.removeChild(payouts[payouts.length - 1]);
        }
      }

      // Update stats function
      function updateStats() {
        const stats = document.querySelectorAll('.text-2xl.font-bold');
        
        // Update tournaments completed
        const currentTournaments = parseInt(stats[0].textContent);
        stats[0].textContent = currentTournaments + 1;
        
        // Update ETH distributed
        const currentETH = parseFloat(stats[1].textContent);
        const newAmount = (currentETH + Math.random() * 3 + 1).toFixed(1);
        stats[1].textContent = newAmount;
        
        // Randomly update active tournaments
        if (Math.random() > 0.5) {
          const currentActive = parseInt(stats[2].textContent);
          stats[2].textContent = Math.max(1, currentActive + (Math.random() > 0.5 ? 1 : -1));
        }
      }

      // Notification system
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all duration-300 ${
          type === 'success' ? 'bg-green-600' : 
          type === 'error' ? 'bg-red-600' : 'bg-blue-600'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }, 3000);
      }

      // Payout card click handlers
      document.addEventListener('click', (e) => {
        const payoutCard = e.target.closest('.p-4.bg-slate-900');
        if (payoutCard && payoutCard.parentElement.id === 'payouts-grid') {
          showPayoutDetails(payoutCard);
        }
      });

      // Show payout details modal
      function showPayoutDetails(payout) {
        const tournament = window.tournamentData.getTournament(payout.tournamentId);
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
          <div class="bg-slate-900 rounded-xl p-6 max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-indigo-300">Payout Details</h3>
              <button class="close-modal text-slate-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="space-y-4">
              <div class="p-4 bg-slate-800 rounded-lg">
                <div class="text-sm text-slate-400 mb-1">Tournament</div>
                <div class="font-semibold text-slate-200">${payout.tournamentName}</div>
                <div class="text-xs text-slate-500 mt-1">Game: ${payout.gameType}</div>
              </div>
              <div class="p-4 bg-slate-800 rounded-lg">
                <div class="text-sm text-slate-400 mb-1">Winner</div>
                <div class="font-semibold text-slate-200">${payout.winner.username}</div>
                <div class="text-xs text-slate-500 mt-1">Position: ${payout.position}</div>
              </div>
              <div class="p-4 bg-slate-800 rounded-lg">
                <div class="text-sm text-slate-400 mb-1">Prize Amount</div>
                <div class="font-semibold text-green-400">${payout.prizeAmount.toFixed(4)} ETH</div>
                <div class="text-xs text-slate-500 mt-1">Total Pool: ${tournament ? tournament.prizePool.toFixed(4) : 'N/A'} ETH</div>
              </div>
              <div class="p-4 bg-slate-800 rounded-lg">
                <div class="text-sm text-slate-400 mb-1">Recipient Address</div>
                <div class="font-mono text-xs text-slate-300 break-all">${payout.winner.address}</div>
              </div>
              <div class="p-4 bg-slate-800 rounded-lg">
                <div class="text-sm text-slate-400 mb-1">Transaction Hash</div>
                <div class="font-mono text-xs text-slate-300 break-all">${payout.transactionHash}</div>
              </div>
              <div class="p-4 bg-slate-800 rounded-lg">
                <div class="text-sm text-slate-400 mb-1">Payout Time</div>
                <div class="text-slate-300">${new Date(payout.timestamp).toLocaleString()}</div>
                <div class="text-xs text-slate-500 mt-1">${window.tournamentData.formatTimeAgo(payout.timestamp)}</div>
              </div>
              <div class="flex gap-2">
                <button class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold transition-colors" onclick="window.open('https://testnet-explorer.kwala.com/tx/${payout.transactionHash}', '_blank')">
                  View on Explorer
                </button>
                <button class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold transition-colors" onclick="shareResult('${payout.tournamentName}', '${payout.winner.username}', '${payout.prizeAmount.toFixed(2)}')">
                  Share Result
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.querySelector('.close-modal').addEventListener('click', () => {
          modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // Share result function
      function shareResult(tournamentName, winner, prize) {
        const text = `🏆 ${winner} just won ${prize} ETH in "${tournamentName}" on TournamentFlow! Join the next tournament: ${window.location.origin}/tournaments.html`;
        
        if (navigator.share) {
          navigator.share({
            title: 'Tournament Victory!',
            text: text,
            url: window.location.origin
          });
        } else {
          navigator.clipboard.writeText(text).then(() => {
            showNotification('Result copied to clipboard!', 'success');
          });
        }
      }

      // Mobile menu toggle
      document.getElementById('mobile-menu').addEventListener('click', () => {
        const nav = document.getElementById('mobile-nav');
        nav.classList.toggle('hidden');
      });

      // Initialize with some activity
      setTimeout(() => {
        if (Math.random() > 0.5) {
          addNewPayout();
          updateStats();
        }
      }, 5000);
    </script>
  </body>
</html>
